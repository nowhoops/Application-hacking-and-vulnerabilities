# H2 Break & Unbreak 
Now we hack! And code!
| specs | vm/os |
|---------|-------------|
| (I7/128/8tb/) | Fedora |


Remember systematic working methods and report as you go. Also reflect: Where could this vulnerability be common? How could this mistake be avoided? What did I learn from this?

    x) Read/watch/listen and summarize. (In this x-subsection, you don't need to do tests on a computer; just reading or listening and a summary is enough. A few bullet points are sufficient for the summary.)

## OWASP: OWASP Top 10: A01 Broken Access Control'
 
### A01: Broken Access Control
- Access granted beyond intended roles/users (violates least privilege)
- Privilege escalation

**Prevention**
- Disable directory listing and remove exposed files (e.g. `.git`, backups)
- Apply rate limiting to APIs and controllers

---

### A02: Cryptographic Failures
- Weak, missing, or outdated cryptography
- Poor protection of data at rest or in transit

**Prevention**
- Classify sensitive data
- Do not store sensitive data unnecessarily
- Encrypt sensitive data at rest and in transit
- Avoid legacy algorithms and protocols

---

### A03: Injection
- Unvalidated user input executed by interpreters
- Dynamic or non-parameterized queries

**Prevention**
- Use parameterized queries or safe APIs (ORMs)
- Validate input server-side
- Never allow user input in SQL structure elements

---

### A04: Insecure Design
- Missing or ineffective security controls
- Design flaws cannot be fixed by implementation alone

**Prevention**
- Apply secure design principles
- Use threat modeling and secure development practices

---

### A05: Security Misconfiguration
- Improper hardening or permissions
- Default credentials enabled
- Excessive error details exposed

**Prevention**
- Remove unnecessary features and defaults
- Secure configurations across the stack
- Use proper error handling

---

### A06: Vulnerable and Outdated Components
- Using unsupported, outdated, or vulnerable software
- Unknown component versions

**Prevention**
- Remove unused components
- Track and inventory all dependencies
- Regularly scan and update components

### A07: Identification and Authentication Failures
- Weak or missing authentication mechanisms
- Poor session management
- Credential stuffing and brute-force attacks

**Prevention**
- Use multi-factor authentication (MFA)
- Enforce strong password policies
- Protect against brute-force attacks (rate limiting, lockout)
- Use secure session management and tokens

---

### A08: Software and Data Integrity Failures
- Untrusted software updates, plugins, or libraries
- Insecure CI/CD pipelines
- Unsigned or unverified data

**Prevention**
- Use signed and verified updates
- Secure CI/CD pipelines
- Validate integrity of software and data

---

### A09: Security Logging and Monitoring Failures
- Insufficient logging of security events
- Delayed or missing incident response

**Prevention**
- Log authentication, access control, and input validation failures
- Monitor logs and alert on suspicious activity
- Establish incident response and recovery plans

---

### A10: Server-Side Request Forgery (SSRF)
- Server makes requests to unintended internal or external resources
- Attackers exploit URL fetch functionality

**Prevention**
- Validate and sanitize all user-supplied URLs
- Restrict outbound network access
- Use allowlists for remote resources
- Disable unused URL fetching features
- Server fetches remote resources without validation

r
        
    
## Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf
    - Web servers may contain hidden directories not linked publicly (e.g. `/admin`, `/.svn`)
- `ffuf` is a fast web fuzzer used to discover hidden paths 
- Use a wordlist (e.g. SecLists `common.txt`) 
- Filter false positives using response size, words, lines, or status codes
- In the example, filtering by response size revealed a hidden `/admin` page
- Always use fuzzing tools legally and ethically, preferably in a local test environment
- 
## PortSwigger: Access control vulnerabilities and privilege escalation
  - Access control defines what authenticated users are allowed to do
- Broken access control allows unauthorized access to actions or data
- Vertical access control: restricts functions by role (e.g. admin vs user)
- Horizontal access control: restricts access to a user’s own resources 

- Vertical privilege escalation: user gains higher-level privileges like admin/root
- Horizontal privilege escalation: user accesses other users’ data
- Horizontal attacks can lead to vertical escalation (e.g. targeting admins)

- Common causes:
  security by obscurity
  - cookies, URLs, hidden fields
  - Platform or framework misconfigurations
  - Weak multi-step process enforcement

- Prevention:
  - Deny access by default
  - Never rely on obscurity alone
  - Enforce access controls server-side and centrally
  - Explicitly define permissions per resource
  - Regularly audit and test access controls
  -
## Karvinen 2006: Report Writing (in Finnish)
- Clearly document what was done, how it was done, and the results
- Write the report during the work, not afterward
- Ensure results are reproducible by describing the environment and not skipping steps
- Keep the report clear and short
- Always reference sources properly
- Never fabricate, plagiarize, or use content without permission
## Optional: PortSwigger 2020: What is SQL injection? - Web Security Academy (about 10 min video)

                - web sec vulnerability allows atacker to view data that they are not ment to see.
        - Can modify or delete data 
        - there is lots of blind vulnerabilitys harder but dangerous
        - usually ocurs inthe were clause of query but can ocure in any location like update, insert, select and order by clause



(Karvinen,2024)


---

### a) Break into 010-staff-only

See Karvinen 2024: *Hack'n Fix* (Karvinen, 2024)

## Hacking goal
Reveal the admin password. It contains the string **"SUPERADMIN"**.

---

## Installing 010-staff-only requirements

```bash
sudo apt-get update  
sudo apt-get -y install wget unzip micro  
cd challenges/010-staff-only/  
python3 staff-only.py  

```

This resulted in the error:


```bash
from flask import Flask, render_template, request # sudo apt-get install python3-flask  
ModuleNotFoundError: No module named 'flask'  
```

I am using Fedora, so instead I ran:


```bash
sudo dnf install python3-flask python3-flask-sqlalchemy -y  

```

Got it working.

![image](https://github.com/user-attachments/assets/b700738c-76b4-47c8-b5aa-af63216c60af)

![image](https://github.com/user-attachments/assets/915344c9-ced9-423f-bead-dadfedc37a65)

---

## FFuF attempts

- Used **FFuF** with no luck  
- Git cloned SecLists from:  
  https://github.com/danielmiessler/SecLists
- Ran FFuF with this command:


```bash
ffuf -u http://127.0.0.1:5000/FUZZ -w SecLists/Discovery/Web-Content/common.txt  

```

I’m not sure if FFuF was correct on the first try, but I haven’t used it before and wanted to try it out.

---

## Next steps

- I tried the obvious input box on the site and noticed that you cannot input letters or special characters.  
- What causes this?  
- I pressed **CTRL + U** to look for JavaScript to remove it.  
- There was none.  
- However, I found this HTML element:


```bash
<input type="number" name="pin" value='-123'>

```

- With Inspect Element, I changed `type="number"` to `type="any"`.  
- It accepted `'`.

---

## SQL Injection

I then tried SQL injection:


```bash
' OR '1'='1

```

I think it worked.

![image](https://github.com/user-attachments/assets/f8b30186-52d4-4a4c-8a30-dfcc43c993b7)

- Got `foo`.

Then I tried:


```bash
' OR password LIKE '%SUPERADMIN%'
```


Things I tried for about 20 minutes before I remembered hearing about this type of attack.

This might not be correct, but it worked:

```bash
' OR 1=1 LIMIT 2,100 --
```

Output:

```bash
SUPERADMIN%%rootALL-FLAG{Tero-e45f8764675e4463db969473b6d0fcdd}
```

I read the first part of the tip. It said that **LIMIT** shows only part of the `SELECT` matches, but I didn’t catch the correct answer from that at first.

---

### b) Fix the 010-staff-only vulnerability from source code

Demonstrate with a test that your solution works.

- For the Python fix I used the help of this site:  
  https://docs.sqlalchemy.org/en/13/dialects/postgresql.html

```Python
@app.route("/", methods=['POST', 'GET'])
def hello():
       pin = request.values.get("pin", "0")
       sql = text("SELECT password FROM pins WHERE pin = :pin")
       clean_pin = {"pin": pin}
       result = db.session.execute(sql, clean_pin)
       row = result.fetchone()
       with app.app_context():
                res = db.session.execute(text(sql), clean_pin)
```

- It took while to figure it out  
- I tried it and it worked  
- It worked out so well it broke the whole question box  
- **No had a typo on the password when I tried it.  
- The fix is that the original code used the user input straight but I made it so that it cleans the input.  
- Did not now what to do with the plain tekst on the code, but it wasn't on the task list so I just left it  

---

## c) Solve dirfuzt-1

I ran the commands:

```bash
wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-0
chmod u+x dirfuzt-0
./dirfuzt-0
```

Learn more at TeroKarvinen.com  
http://127.0.0.2:8000

- The FFUF is already installed  
- First I ran:

```bash
ffuf -u http://127.0.0.2:8000/FUZZ -w SecLists/Discovery/Web-Content/common.txt
```

- That gave me the information that my code worked  
- Got lots of answers. None of them gave me correct answer  
- I also noticed that all of the answers got:  
  `[Status: 200, Size: 132, Words: 6, Lines: 10, Duration: 0ms]`  
- The important thing here is that the size is 132  
- I filtered that with `-fs 132` at the end and got in  

<img width="1145" height="754" alt="image" src="https://github.com/user-attachments/assets/5b3e980b-0cbf-4453-8b19-2af30010dfc6" />

---

## d) Break into 020-your-eyes-only

See Karvinen 2024: *Hack'n Fix*

First the installation:

```bash
cd
cd challenges/020-your-eyes-only/
sudo apt-get -y install virtualenv

virtualenv virtualenv/ -p python3 --system-site-packages
source virtualenv/bin/activate
pip install -r requirements.txt
```

Successfully installed django-4.2.16

```bash
cd logtin/
./manage.py makemigrations; ./manage.py migrate
./manage.py runserver
```

Tested the site with this first:

```bash
ffuf -u http://127.0.0.1:8000/FUZZ -w SecLists/Discovery/Web-Content/common.txt
```

Got this:

- `admin-console` `[Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 81ms]`  
- Tried some SQL injections  
- Noticed the registrations and made a account for myself  
- Now the admin-console just let me in as normal user  

<img width="538" height="262" alt="image" src="https://github.com/user-attachments/assets/28012e97-0e33-487f-bd8c-e096540fcb5a" />

---

## e) How to fix?

- It was quite an easy fix  
- I copied the test function of the one on top of it  

<img width="967" height="145" alt="image" src="https://github.com/user-attachments/assets/d6562e1a-b2fc-4acd-aeb4-299ab02bffb5" />

- Now it works  

<img width="585" height="201" alt="image" src="https://github.com/user-attachments/assets/69a7f9e3-aeca-4312-ae89-c7584ce36524" />




Tips****
source:

 https://github.com/danielmiessler/SecLists.git
https://www.compilenrun.com/docs/framework/flask/flask-security/flask-sql-injection/?utm_source=chatgpt.com
PostgreSQL:**https://docs.sqlalchemy.org/en/13/dialects/postgresql.html**
