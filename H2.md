# H2 Break & Unbreak 
Now we hack! And code!
| specs | vm/os |
|---------|-------------|
| (I7/128/8tb/) | Fedora |


Remember systematic working methods and report as you go. Also reflect: Where could this vulnerability be common? How could this mistake be avoided? What did I learn from this?

    x) Read/watch/listen and summarize. (In this x-subsection, you don't need to do tests on a computer; just reading or listening and a summary is enough. A few bullet points are sufficient for the summary.)

## OWASP: OWASP Top 10: A01 Broken Access Control'
 
### A01: Broken Access Control
- Access granted beyond intended roles/users (violates least privilege)
- Privilege escalation

**Prevention**
- Disable directory listing and remove exposed files (e.g. `.git`, backups)
- Apply rate limiting to APIs and controllers

---

### A02: Cryptographic Failures
- Weak, missing, or outdated cryptography
- Poor protection of data at rest or in transit

**Prevention**
- Classify sensitive data
- Do not store sensitive data unnecessarily
- Encrypt sensitive data at rest and in transit
- Avoid legacy algorithms and protocols

---

### A03: Injection
- Unvalidated user input executed by interpreters
- Dynamic or non-parameterized queries

**Prevention**
- Use parameterized queries or safe APIs (ORMs)
- Validate input server-side
- Never allow user input in SQL structure elements

---

### A04: Insecure Design
- Missing or ineffective security controls
- Design flaws cannot be fixed by implementation alone

**Prevention**
- Apply secure design principles
- Use threat modeling and secure development practices

---

### A05: Security Misconfiguration
- Improper hardening or permissions
- Default credentials enabled
- Excessive error details exposed

**Prevention**
- Remove unnecessary features and defaults
- Secure configurations across the stack
- Use proper error handling

---

### A06: Vulnerable and Outdated Components
- Using unsupported, outdated, or vulnerable software
- Unknown component versions

**Prevention**
- Remove unused components
- Track and inventory all dependencies
- Regularly scan and update components

### A07: Identification and Authentication Failures
- Weak or missing authentication mechanisms
- Poor session management
- Credential stuffing and brute-force attacks

**Prevention**
- Use multi-factor authentication (MFA)
- Enforce strong password policies
- Protect against brute-force attacks (rate limiting, lockout)
- Use secure session management and tokens

---

### A08: Software and Data Integrity Failures
- Untrusted software updates, plugins, or libraries
- Insecure CI/CD pipelines
- Unsigned or unverified data

**Prevention**
- Use signed and verified updates
- Secure CI/CD pipelines
- Validate integrity of software and data

---

### A09: Security Logging and Monitoring Failures
- Insufficient logging of security events
- Delayed or missing incident response

**Prevention**
- Log authentication, access control, and input validation failures
- Monitor logs and alert on suspicious activity
- Establish incident response and recovery plans

---

### A10: Server-Side Request Forgery (SSRF)
- Server makes requests to unintended internal or external resources
- Attackers exploit URL fetch functionality

**Prevention**
- Validate and sanitize all user-supplied URLs
- Restrict outbound network access
- Use allowlists for remote resources
- Disable unused URL fetching features
- Server fetches remote resources without validation

r
        
    
## Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf
    - Web servers may contain hidden directories not linked publicly (e.g. `/admin`, `/.svn`)
- `ffuf` is a fast web fuzzer used to discover hidden paths 
- Use a wordlist (e.g. SecLists `common.txt`) 
- Filter false positives using response size, words, lines, or status codes
- In the example, filtering by response size revealed a hidden `/admin` page
- Always use fuzzing tools legally and ethically, preferably in a local test environment
- 
## PortSwigger: Access control vulnerabilities and privilege escalation
  - Access control defines what authenticated users are allowed to do
- Broken access control allows unauthorized access to actions or data
- Vertical access control: restricts functions by role (e.g. admin vs user)
- Horizontal access control: restricts access to a user’s own resources 

- Vertical privilege escalation: user gains higher-level privileges like admin/root
- Horizontal privilege escalation: user accesses other users’ data
- Horizontal attacks can lead to vertical escalation (e.g. targeting admins)

- Common causes:
  security by obscurity
  - cookies, URLs, hidden fields
  - Platform or framework misconfigurations
  - Weak multi-step process enforcement

- Prevention:
  - Deny access by default
  - Never rely on obscurity alone
  - Enforce access controls server-side and centrally
  - Explicitly define permissions per resource
  - Regularly audit and test access controls
  -
## Karvinen 2006: Report Writing (in Finnish)
- Clearly document what was done, how it was done, and the results
- Write the report during the work, not afterward
- Ensure results are reproducible by describing the environment and not skipping steps
- Keep the report clear and short
- Always reference sources properly
- Never fabricate, plagiarize, or use content without permission
## Optional: PortSwigger 2020: What is SQL injection? - Web Security Academy (about 10 min video)

                - web sec vulnerability allows atacker to view data that they are not ment to see.
        - Can modify or delete data 
        - there is lots of blind vulnerabilitys harder but dangerous
        - usually ocurs inthe were clause of query but can ocure in any location like update, insert, select and order by clause



(Karvinen,2024)


---

### a) Break into 010-staff-only  
See Karvinen 2024: *Hack'n Fix* (Karvinen, 2024)

## Hacking goal
Reveal the admin password. It contains the string **"SUPERADMIN"**.

---

## Installing 010-staff-only requirements
```Bash
sudo apt-get update  
sudo apt-get -y install wget unzip micro  
cd challenges/010-staff-only/  
python3 staff-only.py  
```

This resulted in the error:

```Bash
from flask import Flask, render_template, request # sudo apt-get install python3-flask  
ModuleNotFoundError: No module named 'flask'  
```

I am using Fedora, so instead I ran:

```Bash
sudo dnf install python3-flask python3-flask-sqlalchemy -y  
```

Got it working.

![image](https://github.com/user-attachments/assets/b700738c-76b4-47c8-b5aa-af63216c60af)

![image](https://github.com/user-attachments/assets/915344c9-ced9-423f-bead-dadfedc37a65)

---

## FFuF attempts

- Used **FFuF** with no luck  
- Git cloned SecLists from:  
  https://github.com/danielmiessler/SecLists
- Ran FFuF with this command:

```Bash
ffuf -u http://127.0.0.1:5000/FUZZ -w SecLists/Discovery/Web-Content/common.txt  
```

I’m not sure if FFuF was correct on the first try, but I haven’t used it before and wanted to try it out.

---

## Next steps

- I tried the obvious input box on the site and noticed that you cannot input letters or special characters.  
- What causes this?  
- I pressed **CTRL + U** to look for JavaScript to remove it.  
- There was none.  
- However, I found this HTML element:
```Bash
<input type="number" name="pin" value='-123'>
```

- With Inspect Element, I changed `type="number"` to `type="any"`.  
- It accepted `'`.

---

## SQL Injection

I then tried SQL injection:

```Bash
' OR '1'='1
```

I think it worked.

![image](https://github.com/user-attachments/assets/f8b30186-52d4-4a4c-8a30-dfcc43c993b7)

- Got `foo`.

Then I tried:

```Bash
' OR password LIKE '%SUPERADMIN%'
```

Tried 
Things I tried for about 20 minutes before I remembered hearing about this type of attack.

This might not be correct, but it worked:

```Bash
' OR 1=1 LIMIT 2,100 --
```

Output:

```Bash
SUPERADMIN%%rootALL-FLAG{Tero-e45f8764675e4463db969473b6d0fcdd}
```

I read the first part of the tip. It said that **LIMIT** shows only part of the `SELECT` matches, but I didn’t catch the correct answer from that at first.




- 
    b) Fix the 010-staff-only vulnerability from source code. Demonstrate with a test that your solution works.


- for the python fix I used the help of this site (https://docs.sqlalchemy.org/en/13/dialects/postgresql.html)
@app.route("/", methods=['POST', 'GET'])
def hello():
       pin = request.values.get("pin", "0")
       sql = text("SELECT password FROM pins WHERE pin = :pin")
       clean_pin ={"pin": pin})
       result = db.session.execute(sql, clean_pin;)
       row = result.fetchone()
       with app.app_context():
                res=db.session.execute(text(sql, clean_pin))

  - It took while to figure it out
  - I tried it and it worked
  - It worked out so well it broke the whole question box
 - **No had a typo on the password when I tried it.
 - The fix iss that the original code used the user input straight but I made it so that it cleans the input.

 - Did not now what to do with the plain tekst on the code
 - For the report, explain

    Environment
        OS, browser, hardware, network
        Any precautions taken
            For example: if using automated crawlers and fuzzers you're not familiar yet, disconnecting Internet when running the tools.
    Hack
        What methods you used for testing the applications (successfull and unsuccesfull).
        What the vulnerability is?
        How to exploit the vulnerability and how each part of your exploit work.
        Refer all documentation and sources you used
    Fix
        Which area of code has the mistake
        What the mistake is? Do you have a guess how programmer has made this mistake?
        How does your fix work?
        Does your fix have any downsides? Any areas that should be checked or explored in the future?
        Refer all documentation and sources you used
    Reflect
        What kind of targets could have this type of vulnerability?
        Is this likely to be common or realistic scennario?
        How could this vulnerability be avoided?
        Any other lessons learned.
- 

## c) Solve dirfuzt-1
-I ran the commands
Bash
$ wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-0
$ chmod u+x dirfuzt-0
$ ./dirfuzt-0
Learn more at TeroKarvinen.com
http://127.0.0.2:8000

the FFUF is already installed
- first I ran
  ffuf -u http://127.0.0.2:8000/FUZZ -w SecLists/Discovery/Web-Content/common.txt
- that gave me the information that  my code worked.
- Got lots of answers. Non of them gave me correct answer
- I alson noticed that all of the answers got:[Status: 200, Size: 132, Words: 6, Lines: 10, Duration: 0ms]
- The importat thing here is that the size is 132.
- I filtered that with -fs 132 at the end and got in
- 

  <img width="1145" height="754" alt="image" src="https://github.com/user-attachments/assets/5b3e980b-0cbf-4453-8b19-2af30010dfc6" />


D)d) Break into 020-your-eyes-only. See Karvinen 2024: Hack'n Fix

- First the installation'
cd
cd challenges/020-your-eyes-only/
sudo apt-get -y install virtualenv

virtualenv virtualenv/ -p python3 --system-site-packages
source virtualenv/bin/activate
pip install -r requirements.txt
Successfully installed django-4.2.16
cd logtin/
./manage.py makemigrations; ./manage.py migrate
./manage.py runserver

- with this :ffuf -u http://127.0.0.1:8000/FUZZ -w SecLists/Discovery/Web-Content/common.txt
 got this:
-admin-console           [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 81ms]
-Tried some sql injections
- Noticed the registrations and made a account for myself

- now the admin-console just let me in as normal user.
<img width="538" height="262" alt="image" src="https://github.com/user-attachments/assets/28012e97-0e33-487f-bd8c-e096540fcb5a" />

## e) How to fix?


Tips****
source:

 https://github.com/danielmiessler/SecLists.git
https://www.compilenrun.com/docs/framework/flask/flask-security/flask-sql-injection/?utm_source=chatgpt.com
PostgreSQL:**https://docs.sqlalchemy.org/en/13/dialects/postgresql.html**
