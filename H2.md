# H2 Break & Unbreak 
Now we hack! And code!
| specs | vm/os |
|---------|-------------|
| (I7/128/8tb/) | Fedora |


Remember systematic working methods and report as you go. Also reflect: Where could this vulnerability be common? How could this mistake be avoided? What did I learn from this?

    x) Read/watch/listen and summarize. (In this x-subsection, you don't need to do tests on a computer; just reading or listening and a summary is enough. A few bullet points are sufficient for the summary.)

## OWASP: OWASP Top 10: A01 Broken Access Control'
 
### A01: Broken Access Control
- Access granted beyond intended roles/users (violates least privilege)
- Privilege escalation

**Prevention**
- Disable directory listing and remove exposed files (e.g. `.git`, backups)
- Apply rate limiting to APIs and controllers

---

### A02: Cryptographic Failures
- Weak, missing, or outdated cryptography
- Poor protection of data at rest or in transit

**Prevention**
- Classify sensitive data
- Do not store sensitive data unnecessarily
- Encrypt sensitive data at rest and in transit
- Avoid legacy algorithms and protocols

---

### A03: Injection
- Unvalidated user input executed by interpreters
- Dynamic or non-parameterized queries

**Prevention**
- Use parameterized queries or safe APIs (ORMs)
- Validate input server-side
- Never allow user input in SQL structure elements

---

### A04: Insecure Design
- Missing or ineffective security controls
- Design flaws cannot be fixed by implementation alone

**Prevention**
- Apply secure design principles
- Use threat modeling and secure development practices

---

### A05: Security Misconfiguration
- Improper hardening or permissions
- Default credentials enabled
- Excessive error details exposed

**Prevention**
- Remove unnecessary features and defaults
- Secure configurations across the stack
- Use proper error handling

---

### A06: Vulnerable and Outdated Components
- Using unsupported, outdated, or vulnerable software
- Unknown component versions

**Prevention**
- Remove unused components
- Track and inventory all dependencies
- Regularly scan and update components

### A07: Identification and Authentication Failures
- Weak or missing authentication mechanisms
- Poor session management
- Credential stuffing and brute-force attacks

**Prevention**
- Use multi-factor authentication (MFA)
- Enforce strong password policies
- Protect against brute-force attacks (rate limiting, lockout)
- Use secure session management and tokens

---

### A08: Software and Data Integrity Failures
- Untrusted software updates, plugins, or libraries
- Insecure CI/CD pipelines
- Unsigned or unverified data

**Prevention**
- Use signed and verified updates
- Secure CI/CD pipelines
- Validate integrity of software and data

---

### A09: Security Logging and Monitoring Failures
- Insufficient logging of security events
- Delayed or missing incident response

**Prevention**
- Log authentication, access control, and input validation failures
- Monitor logs and alert on suspicious activity
- Establish incident response and recovery plans

---

### A10: Server-Side Request Forgery (SSRF)
- Server makes requests to unintended internal or external resources
- Attackers exploit URL fetch functionality

**Prevention**
- Validate and sanitize all user-supplied URLs
- Restrict outbound network access
- Use allowlists for remote resources
- Disable unused URL fetching features
- Server fetches remote resources without validation

r
        
    
## Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf
    - Web servers may contain hidden directories not linked publicly (e.g. `/admin`, `/.svn`)
- `ffuf` is a fast web fuzzer used to discover hidden paths 
- Use a wordlist (e.g. SecLists `common.txt`) 
- Filter false positives using response size, words, lines, or status codes
- In the example, filtering by response size revealed a hidden `/admin` page
- Always use fuzzing tools legally and ethically, preferably in a local test environment
- 
## PortSwigger: Access control vulnerabilities and privilege escalation
  - Access control defines what authenticated users are allowed to do
- Broken access control allows unauthorized access to actions or data
- Vertical access control: restricts functions by role (e.g. admin vs user)
- Horizontal access control: restricts access to a user’s own resources 

- Vertical privilege escalation: user gains higher-level privileges like admin/root
- Horizontal privilege escalation: user accesses other users’ data
- Horizontal attacks can lead to vertical escalation (e.g. targeting admins)

- Common causes:
  security by obscurity
  - cookies, URLs, hidden fields
  - Platform or framework misconfigurations
  - Weak multi-step process enforcement

- Prevention:
  - Deny access by default
  - Never rely on obscurity alone
  - Enforce access controls server-side and centrally
  - Explicitly define permissions per resource
  - Regularly audit and test access controls
  -
## Karvinen 2006: Report Writing (in Finnish)
- Clearly document what was done, how it was done, and the results
- Write the report during the work, not afterward
- Ensure results are reproducible by describing the environment and not skipping steps
- Keep the report clear and short
- Always reference sources properly
- Never fabricate, plagiarize, or use content without permission
## Optional: PortSwigger 2020: What is SQL injection? - Web Security Academy (about 10 min video)

                - web sec vulnerability allows atacker to view data that they are not ment to see.
        - Can modify or delete data 
        - there is lots of blind vulnerabilitys harder but dangerous
        - usually ocurs inthe were clause of query but can ocure in any location like update, insert, select and order by clause



(Karvinen,2024)


---

### a) Break into 010-staff-only  
See Karvinen 2024: *Hack'n Fix* (Karvinen, 2024)

## Hacking goal
Reveal the admin password. It contains the string **"SUPERADMIN"**.

---

## Installing 010-staff-only requirements
```Bash
sudo apt-get update  
sudo apt-get -y install wget unzip micro  
cd challenges/010-staff-only/  
python3 staff-only.py  
```

This resulted in the error:

```Bash
from flask import Flask, render_template, request # sudo apt-get install python3-flask  
ModuleNotFoundError: No module named 'flask'  
```

I am using Fedora, so instead I ran:

```Bash
sudo dnf install python3-flask python3-flask-sqlalchemy -y  
```

Got it working.

![image](https://github.com/user-attachments/assets/b700738c-76b4-47c8-b5aa-af63216c60af)

![image](https://github.com/user-attachments/assets/915344c9-ced9-423f-bead-dadfedc37a65)

---

## FFuF attempts

- Used **FFuF** with no luck  
- Git cloned SecLists from:  
  https://github.com/danielmiessler/SecLists
- Ran FFuF with this command:

```Bash
ffuf -u http://127.0.0.1:5000/FUZZ -w SecLists/Discovery/Web-Content/common.txt  
```

I’m not sure if FFuF was correct on the first try, but I haven’t used it before and wanted to try it out.

---

## Next steps

- I tried the obvious input box on the site and noticed that you cannot input letters or special characters.  
- What causes this?  
- I pressed **CTRL + U** to look for JavaScript to remove it.  
- There was none.  
- However, I found this HTML element:
```Bash
<input type="number" name="pin" value='-123'>
```

- With Inspect Element, I changed `type="number"` to `type="any"`.  
- It accepted `'`.

---

## SQL Injection

I then tried SQL injection:

```Bash
' OR '1'='1
```

I think it worked.

![image](https://github.com/user-attachments/assets/f8b30186-52d4-4a4c-8a30-dfcc43c993b7)

- Got `foo`.

Then I tried:

```Bash
' OR password LIKE '%SUPERADMIN%'
```

Tried 
Things I tried for about 20 minutes before I remembered hearing about this type of attack.

This might not be correct, but it worked:

```Bash
' OR 1=1 LIMIT 2,100 --
```

Output:

```Bash
SUPERADMIN%%rootALL-FLAG{Tero-e45f8764675e4463db969473b6d0fcdd}
```

I read the first part of the tip. It said that **LIMIT** shows only part of the `SELECT` matches, but I didn’t catch the correct answer from that at first.




- 
    b) Fix the 010-staff-only vulnerability from source code. Demonstrate with a test that your solution works.


#!/usr/bin/python3
# Copyright 2018-2024 Tero Karvinen http://TeroKarvinen.com
#########################################
# WARNING: Purposefully VULNERABLE APP! #
#########################################

from flask import Flask, render_template, request # sudo apt-get install python3-flask
from flask_sqlalchemy import SQLAlchemy # sudo apt-get install python3-flask-sqlalchemy
from sqlalchemy import text

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
db = SQLAlchemy(app)

@app.route("/", methods=['POST', 'GET'])
def hello():
       pin = request.values.get("pin", "0")
       sql = text("SELECT password FROM pins WHERE pin = :pin")
       result = db.session.execute(sql, {"pin": pin})
       row = result.fetchone()
       if row is None:
           password = "(not found)"
       else:
           password = row[0]
       return render_template("index.html", password=password, pin=pin)


def runSql(sql):
	with app.app_context():
		res=db.session.execute(text(sql))
		db.session.commit()
		return res

def initDb():
	# For simplifying the demo, passwords are also incorrectly stored as plain text. 
	# However, that's not the only thing that's wrong.
	runSql("CREATE TABLE pins (id SERIAL PRIMARY KEY, pin VARCHAR(17), password VARCHAR(20));")
	runSql("INSERT INTO pins(pin, password) VALUES ('321', 'foo');")
	runSql("INSERT INTO pins(pin, password) VALUES ('123', 'Somedude');")
	runSql("INSERT INTO pins(pin, password) VALUES ('11112222333', 'SUPERADMIN%%rootALL-FLAG{Tero-e45f8764675e4463db969473b6d0fcdd}');")
	runSql("INSERT INTO pins(pin, password) VALUES ('321', 'loremipsum');")

if __name__ == "__main__":
	print("WARNING: Purposefully VULNERABLE APP!")
	initDb()
	app.run() # host="0.0.0.0" to serve non-localhost, e.g. from vagrant; debug=True for debug









  Hack

    What methods you used for testing the applications (successfull and unsuccesfull).
    What the vulnerability is?
    How to exploit the vulnerability and how each part of your exploit work.
    Refer all documentation and sources you used

Fix

    Which area of code has the mistake
    What the mistake is? Do you have a guess how programmer has made this mistake?
    How does your fix work?
    Does your fix have any downsides? Any areas that should be checked or explored in the future?
    Refer all documentation and sources you used

Reflect

    What kind of targets could have this type of vulnerability?
    Is this likely to be common or realistic scennario?
    How could this vulnerability be avoided?
    Any other lessons learned.


    c) Solve dirfuzt-1 from the article Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf. This helps in solving 020-your-eyes-only.
    d) Break into 020-your-eyes-only. See Karvinen 2024: Hack'n Fix
    e) Fix the 020-your-eyes-only vulnerability. Demonstrate with a test that your solution works.
    g) Optional. Introductory exercise that helps solve 010-staff-only. Solve Portswigger Academy's "Lab: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data".
    h) Optional. Introductory exercise that helps solve 010-staff-only. Solve Portswigger Academy's "Lab: SQL injection vulnerability allowing login bypass"

Tips****
source:

 https://github.com/danielmiessler/SecLists.git
https://www.compilenrun.com/docs/framework/flask/flask-security/flask-sql-injection/?utm_source=chatgpt.com
